name: Build, Test, and Publish Packs

on:
  push:
    branches: ["**"]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  OCI_REGISTRY: ghcr.io
  OCI_NAMESPACE: ${{ github.repository_owner }}/greentic-messaging-providers

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          key: build-test-publish

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Step 01 - Cargo fmt
        run: ./ci/steps/01_fmt.sh

  clippy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          key: build-test-publish

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Step 02 - Cargo clippy
        run: ./ci/steps/02_clippy.sh

  check-op-schemas:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          key: build-test-publish

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Step 05 - Check component operation schemas
        run: ./ci/steps/05_check_op_schemas.sh

  build-components:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component:
          - provision
          - questions
          - secrets-probe
          - slack
          - teams
          - telegram
          - telegram-webhook
          - webchat
          - webex
          - webex-webhook
          - whatsapp
          - messaging-ingress-slack
          - messaging-ingress-teams
          - messaging-ingress-telegram
          - messaging-ingress-whatsapp
          - messaging-provider-dummy
          - messaging-provider-telegram
          - messaging-provider-teams
          - messaging-provider-email
          - messaging-provider-slack
          - messaging-provider-webex
          - messaging-provider-whatsapp
          - messaging-provider-webchat
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint for legacy HTTP imports
        if: matrix.component == 'provision'
        run: |
          if rg -n 'greentic:http/http-client@' components/ -S; then
            echo "legacy greentic:http/http-client@ import still present in components/"
            exit 1
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip2
          components: rustfmt, clippy

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          key: build-test-publish

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Install cargo-binstall
        run: |
          if ! command -v cargo-binstall >/dev/null 2>&1; then
            cargo install cargo-binstall --locked
          fi

      - name: Install cargo-component
        run: |
          cargo binstall cargo-component --force --no-confirm --locked || cargo install cargo-component --force --locked

      - name: Cache component wasm
        id: cache-component
        uses: actions/cache@v4
        with:
          path: target/components/${{ matrix.component }}.wasm
          key: component-wasm-${{ matrix.component }}-${{ runner.os }}-${{ hashFiles('components/**', 'crates/**', 'wit/**', 'Cargo.toml', 'Cargo.lock', 'rust-toolchain.toml', 'tools/build_component_env.sh', 'tools/build_component_one.sh', 'tools/build_components/**') }}

      - name: Step 03 - Build components
        if: steps.cache-component.outputs.cache-hit != 'true'
        run: bash "./tools/build_components/${{ matrix.component }}.sh"

      - name: Upload component artifacts
        uses: actions/upload-artifact@v4
        with:
          name: components-wasm-${{ matrix.component }}
          path: target/components/${{ matrix.component }}.wasm
          if-no-files-found: error

  ensure-templates:
    runs-on: ubuntu-latest
    needs: build-components
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download component artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: components-wasm-*
          path: target/components
          merge-multiple: true

      - name: Step 04 - Ensure templates are staged in packs
        run: ./ci/steps/04_ensure_templates.sh

  gen-flows:
    runs-on: ubuntu-latest
    needs: [ensure-templates, build-components]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          key: build-test-publish

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Download component artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: components-wasm-*
          path: target/components
          merge-multiple: true

      - name: Stage provision/questions wasm for packgen
        run: |
          mkdir -p components/provision components/questions
          if [ -f target/components/provision.wasm ]; then
            cp target/components/provision.wasm components/provision/provision.wasm
          fi
          if [ -f target/components/questions.wasm ]; then
            cp target/components/questions.wasm components/questions/questions.wasm
          fi

      - name: Step 06 - Generate flows
        run: ./ci/steps/06_gen_flows.sh

  sync-packs:
    runs-on: ubuntu-latest
    needs: [build-components, ensure-templates, gen-flows]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          key: build-test-publish

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Install cargo-binstall
        run: |
          if ! command -v cargo-binstall >/dev/null 2>&1; then
            cargo install cargo-binstall --locked
          fi

      - name: Install oras
        uses: oras-project/setup-oras@v1
        with:
          version: 1.2.0

      - name: Download component artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: components-wasm-*
          path: target/components
          merge-multiple: true

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | oras login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Step 07 - Sync packs
        run: ./ci/steps/07_sync_packs.sh

  flow-doctor:
    runs-on: ubuntu-latest
    needs: sync-packs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Install cargo-binstall
        run: |
          if ! command -v cargo-binstall >/dev/null 2>&1; then
            cargo install cargo-binstall --locked
          fi

      - name: Install greentic-flow
        run: |
          cargo binstall greentic-flow --force --no-confirm --locked || cargo install greentic-flow --force --locked

      - name: Step 08 - Flow doctor
        run: ./ci/steps/08_flow_doctor.sh

  component-doctor:
    runs-on: ubuntu-latest
    needs: sync-packs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Install cargo-binstall
        run: |
          if ! command -v cargo-binstall >/dev/null 2>&1; then
            cargo install cargo-binstall --locked
          fi

      - name: Install greentic-component
        run: |
          cargo binstall greentic-component --force --no-confirm --locked || cargo install greentic-component --force --locked

      - name: Step 09 - Component doctor
        run: ./ci/steps/09_component_doctor.sh

  questions-component-test:
    runs-on: ubuntu-latest
    needs: sync-packs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Install cargo-binstall
        run: |
          if ! command -v cargo-binstall >/dev/null 2>&1; then
            cargo install cargo-binstall --locked
          fi

      - name: Install greentic-component
        run: |
          cargo binstall greentic-component --force --no-confirm --locked || cargo install greentic-component --force --locked

      - name: Step 10 - Questions component tests
        run: ./ci/steps/10_questions_component_test.sh

  build-packs:
    runs-on: ubuntu-latest
    needs: [sync-packs, flow-doctor, component-doctor, questions-component-test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Install cargo-binstall
        run: |
          if ! command -v cargo-binstall >/dev/null 2>&1; then
            cargo install cargo-binstall --locked
          fi

      - name: Install greentic-pack
        env:
          CARGO_NET_GIT_FETCH_WITH_CLI: "true"
        run: |
          cargo binstall greentic-pack --force --no-confirm --locked || cargo install greentic-pack --force --locked
          echo "${HOME}/.cargo/bin" >> "${GITHUB_PATH}"
          greentic-pack --version

      - name: Install greentic-flow
        run: |
          cargo binstall greentic-flow --force --no-confirm --locked || cargo install greentic-flow --force --locked

      - name: Install greentic-runner
        run: |
          cargo binstall greentic-runner --force --no-confirm --locked || cargo install greentic-runner --force --locked

      - name: Install greentic-component
        run: |
          cargo binstall greentic-component --force --no-confirm --locked || cargo install greentic-component --force --locked

      - name: Install oras
        uses: oras-project/setup-oras@v1
        with:
          version: 1.2.0

      - name: Download component artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: components-wasm-*
          path: target/components
          merge-multiple: true

      - name: Step 11 - Build packs
        run: ./ci/steps/11_build_packs.sh

      - name: Upload packs + fixtures report on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: packs-and-fixtures
          path: |
            dist/packs/*.gtpack
            dist/fixtures_report.json
          if-no-files-found: error

      - name: Upload packs lockfile (dry-run)
        uses: actions/upload-artifact@v4
        with:
          name: packs-lockfile-dryrun
          path: packs.lock.json
          if-no-files-found: error

  cargo-test:
    runs-on: ubuntu-latest
    needs: build-components
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip2
          components: rustfmt, clippy

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          key: build-test-publish

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Install cargo-binstall
        run: |
          if ! command -v cargo-binstall >/dev/null 2>&1; then
            cargo install cargo-binstall --locked
          fi

      - name: Install cargo-component
        run: |
          cargo binstall cargo-component --force --no-confirm --locked || cargo install cargo-component --force --locked

      - name: Install greentic-flow
        run: |
          cargo binstall greentic-flow --force --no-confirm --locked || cargo install greentic-flow --force --locked

      - name: Install greentic-pack
        env:
          CARGO_NET_GIT_FETCH_WITH_CLI: "true"
        run: |
          cargo binstall greentic-pack --force --no-confirm --locked || cargo install greentic-pack --force --locked
          echo "${HOME}/.cargo/bin" >> "${GITHUB_PATH}"
          greentic-pack --version

      - name: Download component artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: components-wasm-*
          path: target/components
          merge-multiple: true

      - name: Step 12 - Cargo tests
        env:
          CARGO_BUILD_JOBS: "1"
          RUSTFLAGS: "-C debuginfo=0"
          RUST_BACKTRACE: "1"
        run: ./ci/steps/12_cargo_test.sh

  publish:
    runs-on: ubuntu-latest
    needs: [fmt, clippy, check-op-schemas, build-packs, cargo-test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip2
          components: rustfmt, clippy

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          key: build-test-publish

      - name: Cache cargo bin tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
          key: cargo-bin-tools-${{ runner.os }}-v1

      - name: Install cargo-binstall
        run: |
          if ! command -v cargo-binstall >/dev/null 2>&1; then
            cargo install cargo-binstall --locked
          fi

      - name: Install greentic-pack
        env:
          CARGO_NET_GIT_FETCH_WITH_CLI: "true"
        run: |
          cargo binstall greentic-pack --force --no-confirm --locked || cargo install greentic-pack --force --locked
          echo "${HOME}/.cargo/bin" >> "${GITHUB_PATH}"
          greentic-pack --version

      - name: Install oras
        uses: oras-project/setup-oras@v1
        with:
          version: 1.2.0

      - name: Download component artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: components-wasm-*
          path: target/components
          merge-multiple: true

      - name: Set publish version
        run: |
          python3 - <<'PY'
          import os
          import tomllib
          from pathlib import Path

          data = tomllib.loads(Path("Cargo.toml").read_text())
          version = data["workspace"]["package"]["version"]
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as handle:
            handle.write(f"PUBLISH_VERSION={version}\n")
          print(f"Using Cargo workspace version: {version}")
          PY

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | oras login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Publish components
        env:
          VERSION: ${{ env.PUBLISH_VERSION }}
          PUBLISH_LATEST: "1"
        run: bash ./tools/publish_oci.sh

      - name: Upload components lockfile
        uses: actions/upload-artifact@v4
        with:
          name: components-lockfile
          path: components.lock.json
          if-no-files-found: error

      - name: Publish packs
        env:
          PACK_VERSION: ${{ env.PUBLISH_VERSION }}
          PUBLISH_LATEST: "1"
        run: ./tools/publish_packs_oci.sh

      - name: Upload built packs
        uses: actions/upload-artifact@v4
        with:
          name: gtpack-artifacts
          path: dist/packs/*.gtpack
          if-no-files-found: error
