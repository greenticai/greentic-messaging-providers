// SPDX-License-Identifier: MIT

package greentic:component@0.6.0;

/// Cooperative control-plane hooks surfaced to components.
interface control {
  /// Returns true when the host requests cancellation.
  should-cancel: func() -> bool;

  /// Yields execution back to the host.
  yield-now: func();
}

/// World that exports the node functions directly.
world node {
  import control;
  /// Environment identifier.
  type env-id = string;

  /// Tenant identifier propagated across providers.
  type tenant-id = string;

  /// Team identifier scoped to a tenant.
  type team-id = string;

  /// User identifier scoped to a tenant.
  type user-id = string;

  /// Stable key referencing sessions.
  type session-key = string;

  /// Impersonation context propagated with a tenant.
  record impersonation {
    actor-id: user-id,
    reason: option<string>,
  }

  type json = string;

  /// Invocation tenant context shared across Greentic surfaces.
  record tenant-ctx {
    env: env-id,
    tenant: tenant-id,
    tenant-id: tenant-id,
    team: option<team-id>,
    team-id: option<team-id>,
    user: option<user-id>,
    user-id: option<user-id>,
    trace-id: option<string>,
    i18n-id: option<string>,
    correlation-id: option<string>,
    attributes: list<tuple<string, string>>,
    session-id: option<session-key>,
    flow-id: option<string>,
    node-id: option<string>,
    provider-id: option<string>,
    deadline-ms: option<s64>,
    attempt: u32,
    idempotency-key: option<string>,
    impersonation: option<impersonation>,
  }

  /// Provides execution context for a single flow node invocation.
  record exec-ctx {
    tenant: tenant-ctx,
    i18n-id: option<string>,
    flow-id: string,
    node-id: option<string>,
  }

  /// A structured error code propagated back to the orchestrator.
  record node-error {
    code: string,
    message: string,
    retryable: bool,
    backoff-ms: option<u64>,
    details: option<json>,
  }

  /// Result of an invoke operation.
  variant invoke-result {
    ok(json),
    err(node-error),
  }

  /// Streaming events emitted when executing invoke-stream.
  variant stream-event {
    data(json),
    progress(u8),
    done,
    error(string),
  }

  /// Signals lifecycle success without carrying additional data.
  enum lifecycle-status {
    ok,
  }

  /// Configuration for this component.
  /// Tooling will map this record to JSON Schema.
  /// @config
  record config {
    /// Human-friendly title presented in UIs.
    title: string,
    /// Optional description used in documentation or previews.
    description: option<string>,
    /// Layout hint for hosts rendering collections.
    /// @default("stacked")
    layout: display-mode,
    /// Maximum items to emit before truncating results.
    /// @default(10)
    max-items: u32,
    /// Optional tags to filter or route requests.
    tags: option<list<string>>,
    /// Connection identifier propagated by flows but hidden from user config.
    /// @flow:hidden
    connection-id: option<string>,
  }

  /// Layout preference for rendered results.
  enum display-mode {
    stacked,
    grid,
  }

  /// Returns a JSON manifest describing the component's capabilities.
  export get-manifest: func() -> json;

  /// Optional lifecycle hook when the component starts.
  export on-start: func(ctx: exec-ctx) -> result<lifecycle-status, string>;

  /// Optional lifecycle hook when the component stops.
  export on-stop: func(ctx: exec-ctx, reason: string) -> result<lifecycle-status, string>;

  /// Invokes an operation with execution context and JSON payload.
  export invoke: func(ctx: exec-ctx, op: string, input: json) -> invoke-result;

  /// Invokes an operation that emits a bounded list of streaming events.
  export invoke-stream: func(ctx: exec-ctx, op: string, input: json) -> list<stream-event>;
}
